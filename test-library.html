<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test UltraCompressPro Library</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test-section {
            background: #252526;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .test-title {
            color: #4ec9b0;
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 4px;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #ce9178; }
        .info { color: #9cdcfe; }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ UltraCompressPro Library Test Suite</h1>

    <div class="test-section">
        <div class="test-title">üì¶ 1. Ki·ªÉm tra Library Load</div>
        <div id="loadTest"></div>
    </div>

    <div class="test-section">
        <div class="test-title">‚úÖ 2. Ki·ªÉm tra Public Methods</div>
        <div id="methodsTest"></div>
    </div>

    <div class="test-section">
        <div class="test-title">üéØ 3. Test Compress Single Image</div>
        <input type="file" id="singleFile" accept="image/*">
        <button onclick="testSingleCompress()">Test N√©n 1 ·∫¢nh</button>
        <div id="singleTest"></div>
    </div>

    <div class="test-section">
        <div class="test-title">üìö 4. Test Batch Compress (Multiple Images)</div>
        <input type="file" id="multipleFiles" accept="image/*" multiple>
        <button onclick="testBatchCompress()">Test N√©n Nhi·ªÅu ·∫¢nh</button>
        <div id="batchTest"></div>
    </div>

    <div class="test-section">
        <div class="test-title">üìä 5. Test Progress Callback</div>
        <div id="progressTest"></div>
        <div style="background: #1e1e1e; height: 30px; border-radius: 4px; overflow: hidden; margin-top: 10px;">
            <div id="progressBar" style="height: 100%; background: #007acc; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;"></div>
        </div>
    </div>

    <div class="test-section">
        <div class="test-title">‚úÇÔ∏è 6. Test Crop Functionality</div>
        <input type="file" id="cropFile" accept="image/*">
        <button onclick="testCropFunctionality()">Test Crop</button>
        <div id="cropTest"></div>
    </div>

    <script src="compresslib.js"></script>
    <script>
        let compressor;
        let testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            element.appendChild(div);
        }

        function testPassed(name) {
            testResults.passed++;
            testResults.total++;
            return `<span class="success">‚úÖ PASSED:</span> ${name}`;
        }

        function testFailed(name, error) {
            testResults.failed++;
            testResults.total++;
            return `<span class="error">‚ùå FAILED:</span> ${name}<br><span class="warning">${error}</span>`;
        }

        // Test 1: Library Load
        function testLibraryLoad() {
            try {
                if (typeof UltraCompressPro === 'undefined') {
                    log('loadTest', testFailed('Library not found', 'UltraCompressPro is undefined'), 'error');
                    return;
                }

                compressor = new UltraCompressPro();
                log('loadTest', testPassed('Library loaded successfully'), 'success');

                const validation = compressor.validateLibrary();
                log('loadTest', `<pre>${JSON.stringify(validation, null, 2)}</pre>`, 'info');
                log('loadTest', testPassed('Library validation passed'), 'success');

            } catch (error) {
                log('loadTest', testFailed('Library initialization', error.message), 'error');
            }
        }

        // Test 2: Public Methods
        function testPublicMethods() {
            const requiredMethods = [
                'validateLibrary',
                'loadImage',
                'createCanvas',
                'canvasToBlob',
                'compress',
                'compressMultiple',
                'getGlobalStats'
            ];

            requiredMethods.forEach(method => {
                if (typeof compressor[method] === 'function') {
                    log('methodsTest', testPassed(`Method "${method}" exists`), 'success');
                } else {
                    log('methodsTest', testFailed(`Method "${method}" missing`, 'Method not found'), 'error');
                }
            });
        }

        // Test 3: Single Image Compress
        async function testSingleCompress() {
            const fileInput = document.getElementById('singleFile');
            const file = fileInput.files[0];

            if (!file) {
                log('singleTest', testFailed('No file selected', 'Please select an image'), 'warning');
                return;
            }

            log('singleTest', `<span class="info">‚è≥ Testing compression on: ${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>`, 'info');

            try {
                const startTime = performance.now();
                const result = await compressor.compress(file, {
                    quality: 'balanced'
                });
                const endTime = performance.now();

                log('singleTest', testPassed(`Compressed in ${(endTime - startTime).toFixed(2)}ms`), 'success');
                log('singleTest', `<pre>${JSON.stringify({
                    original: result.original,
                    versions: result.versions.map(v => ({
                        preset: v.metadata.preset,
                        size: v.metadata.compressedSizeKB + ' KB',
                        dimensions: v.metadata.dimensions,
                        ratio: v.metadata.compressionRatio
                    })),
                    analysis: result.analysis
                }, null, 2)}</pre>`, 'info');

                // Display images
                result.versions.forEach((v, i) => {
                    const img = document.createElement('img');
                    img.src = v.preview;
                    img.style.cssText = 'max-width: 200px; margin: 10px; border: 2px solid #007acc; border-radius: 4px;';
                    img.title = `Version ${i + 1}: ${v.metadata.dimensions}`;
                    document.getElementById('singleTest').appendChild(img);
                });

            } catch (error) {
                log('singleTest', testFailed('Compression failed', error.message), 'error');
            }
        }

        // Test 4: Batch Compress
        async function testBatchCompress() {
            const fileInput = document.getElementById('multipleFiles');
            const files = Array.from(fileInput.files);

            if (files.length === 0) {
                log('batchTest', testFailed('No files selected', 'Please select multiple images'), 'warning');
                return;
            }

            log('batchTest', `<span class="info">‚è≥ Testing batch compression on ${files.length} files...</span>`, 'info');

            try {
                const startTime = performance.now();
                const result = await compressor.compressMultiple(files, {
                    concurrent: 3,
                    quality: 'balanced',
                    onProgress: (progress) => {
                        log('progressTest', `<span class="info">üìä Progress: ${progress.percentage}% (${progress.processed}/${progress.total}) - ${progress.currentFile}</span>`, 'info');
                        document.getElementById('progressBar').style.width = progress.percentage + '%';
                        document.getElementById('progressBar').textContent = progress.percentage + '%';
                    }
                });
                const endTime = performance.now();

                log('batchTest', testPassed(`Batch completed in ${(endTime - startTime).toFixed(2)}ms`), 'success');
                log('batchTest', `<pre>${JSON.stringify(result.summary, null, 2)}</pre>`, 'info');

                log('batchTest', `<span class="success">‚úÖ Successful: ${result.summary.successful}</span>`, 'success');
                log('batchTest', `<span class="error">‚ùå Failed: ${result.summary.failed}</span>`, result.summary.failed > 0 ? 'warning' : 'info');

            } catch (error) {
                log('batchTest', testFailed('Batch compression failed', error.message), 'error');
            }
        }

        // Test 5: Progress Callback is tested in Test 4

        // Test 6: Crop Functionality
        async function testCropFunctionality() {
            const fileInput = document.getElementById('cropFile');
            const file = fileInput.files[0];

            if (!file) {
                log('cropTest', testFailed('No file selected', 'Please select an image'), 'warning');
                return;
            }

            log('cropTest', `<span class="info">‚è≥ Testing crop functionality on: ${file.name}</span>`, 'info');

            try {
                // Test loadImage public method
                const img = await compressor.loadImage(file);
                log('cropTest', testPassed(`loadImage() works - Loaded ${img.width}x${img.height}`), 'success');

                // Test createCanvas
                const canvas = compressor.createCanvas(img, { width: 400, height: 300 });
                log('cropTest', testPassed(`createCanvas() works - Created ${canvas.width}x${canvas.height}`), 'success');

                // Test canvasToBlob
                const blob = await compressor.canvasToBlob(canvas, 'image/jpeg', 0.9);
                log('cropTest', testPassed(`canvasToBlob() works - Size: ${(blob.size / 1024).toFixed(2)} KB`), 'success');

                // Display result
                const preview = URL.createObjectURL(blob);
                const imgEl = document.createElement('img');
                imgEl.src = preview;
                imgEl.style.cssText = 'max-width: 400px; margin: 10px; border: 2px solid #007acc; border-radius: 4px;';
                document.getElementById('cropTest').appendChild(imgEl);

            } catch (error) {
                log('cropTest', testFailed('Crop functionality test', error.message), 'error');
            }
        }

        // Run tests on load
        window.addEventListener('DOMContentLoaded', () => {
            testLibraryLoad();
            if (compressor) {
                testPublicMethods();
            }

            // Summary
            setTimeout(() => {
                const summary = document.createElement('div');
                summary.className = 'test-section';
                summary.innerHTML = `
                    <div class="test-title">üìä Test Summary</div>
                    <div class="test-result ${testResults.failed === 0 ? 'success' : 'warning'}">
                        <strong>Total Tests:</strong> ${testResults.total}<br>
                        <strong class="success">Passed:</strong> ${testResults.passed}<br>
                        <strong class="error">Failed:</strong> ${testResults.failed}
                    </div>
                `;
                document.body.appendChild(summary);
            }, 1000);
        });
    </script>
</body>
</html>