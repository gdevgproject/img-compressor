<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UltraCompress Pro - Professional Image Compression</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Inter", sans-serif;
        background: linear-gradient(
          135deg,
          #1e3c72 0%,
          #2a5298 50%,
          #7e22ce 100%
        );
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        animation: fadeInDown 0.6s ease;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header h1 {
        font-size: 3.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        font-weight: 800;
      }

      .header .subtitle {
        font-size: 1.3em;
        opacity: 0.95;
        font-weight: 300;
      }

      .header .version {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        margin-top: 10px;
      }

      .main-panel {
        background: white;
        border-radius: 24px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        margin-bottom: 30px;
        animation: fadeInUp 0.6s ease;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .upload-area {
        border: 3px dashed #7e22ce;
        border-radius: 20px;
        padding: 80px 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        position: relative;
        overflow: hidden;
      }

      .upload-area::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(126, 34, 206, 0.1) 0%,
          transparent 70%
        );
        animation: pulse 3s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      .upload-area:hover {
        border-color: #6b21a8;
        background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(126, 34, 206, 0.2);
      }

      .upload-area.dragover {
        border-color: #6b21a8;
        background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 5em;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
        animation: bounce 2s ease-in-out infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .upload-text {
        font-size: 1.5em;
        color: #7e22ce;
        margin-bottom: 10px;
        font-weight: 600;
        position: relative;
        z-index: 1;
      }

      .upload-hint {
        color: #6b21a8;
        font-size: 1em;
        position: relative;
        z-index: 1;
      }

      #fileInput {
        display: none;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .control-group {
        background: #f9fafb;
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #e5e7eb;
      }

      .control-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 10px;
        color: #374151;
        font-size: 0.95em;
      }

      .control-group select {
        width: 100%;
        padding: 10px;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        font-size: 1em;
        transition: all 0.3s ease;
      }

      .control-group select:focus {
        outline: none;
        border-color: #7e22ce;
        box-shadow: 0 0 0 3px rgba(126, 34, 206, 0.1);
      }

      .quality-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .quality-btn {
        flex: 1;
        padding: 10px;
        border: 2px solid #d1d5db;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 0.9em;
      }

      .quality-btn:hover {
        border-color: #7e22ce;
        background: #faf5ff;
      }

      .quality-btn.active {
        background: linear-gradient(135deg, #7e22ce 0%, #6b21a8 100%);
        color: white;
        border-color: #7e22ce;
      }

      .crop-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        padding: 20px;
        overflow: auto;
      }

      .crop-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .crop-container {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 1200px;
        width: 100%;
        max-height: 90vh;
        overflow: auto;
      }

      .crop-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .crop-header h2 {
        font-size: 1.8em;
        color: #7e22ce;
      }

      .close-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .close-btn:hover {
        background: #dc2626;
        transform: scale(1.05);
      }

      .crop-preview-area {
        position: relative;
        background: #f3f4f6;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 20px;
        max-height: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .crop-image {
        max-width: 100%;
        max-height: 500px;
        cursor: move;
        user-select: none;
      }

      .crop-frame {
        position: absolute;
        border: 3px solid #7e22ce;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        cursor: move;
      }

      .crop-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .crop-control {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .crop-control label {
        font-weight: 600;
        font-size: 0.9em;
        color: #374151;
      }

      .crop-control input,
      .crop-control select {
        padding: 8px;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.95em;
      }

      .crop-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
      }

      .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .btn-primary {
        background: linear-gradient(135deg, #7e22ce 0%, #6b21a8 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(126, 34, 206, 0.4);
      }

      .btn-secondary {
        background: #e5e7eb;
        color: #374151;
      }

      .btn-secondary:hover {
        background: #d1d5db;
      }

      .progress-section {
        display: none;
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .progress-section.active {
        display: block;
        animation: fadeInUp 0.4s ease;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .progress-header h3 {
        font-size: 1.5em;
        color: #7e22ce;
      }

      .progress-stats {
        display: flex;
        gap: 20px;
        font-size: 0.95em;
        color: #6b7280;
      }

      .progress-bar-container {
        background: #e5e7eb;
        height: 40px;
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        margin-bottom: 15px;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #7e22ce 0%, #a855f7 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.1em;
      }

      .progress-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .progress-item {
        background: #f9fafb;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #7e22ce;
      }

      .progress-item label {
        display: block;
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 5px;
      }

      .progress-item .value {
        display: block;
        font-size: 1.3em;
        font-weight: 700;
        color: #111827;
      }

      .results-grid {
        display: grid;
        gap: 30px;
      }

      .result-item {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        animation: fadeInUp 0.5s ease;
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
      }

      .result-header h3 {
        font-size: 1.4em;
        color: #7e22ce;
        display: flex;
        align-items: center;
        gap: 10px;
        word-break: break-all;
      }

      .result-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        flex-shrink: 0;
      }

      .comparison-view {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
      }

      .version-card {
        background: #f9fafb;
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
      }

      .version-card:hover {
        border-color: #7e22ce;
        box-shadow: 0 8px 20px rgba(126, 34, 206, 0.15);
      }

      .version-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .version-title {
        font-weight: 700;
        font-size: 1.1em;
        color: #374151;
      }

      .version-size {
        font-weight: 600;
        color: #7e22ce;
        font-size: 1.2em;
      }

      .image-preview-wrapper {
        position: relative;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 15px;
        aspect-ratio: 4 / 3;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .image-preview {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
        cursor: zoom-in;
      }

      .image-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(
          to top,
          rgba(0, 0, 0, 0.8) 0%,
          transparent 100%
        );
        padding: 10px;
        color: white;
        font-size: 0.85em;
        font-weight: 600;
      }

      .metadata-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 15px;
      }

      .metadata-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        background: white;
        border-radius: 8px;
        font-size: 0.9em;
      }

      .metadata-label {
        color: #6b7280;
        font-weight: 500;
      }

      .metadata-value {
        color: #111827;
        font-weight: 700;
      }

      .metadata-value.highlight {
        color: #10b981;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .action-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.95em;
      }

      .download-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
      }

      .compare-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
      }

      .compare-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
      }

      .original-info {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border-left: 5px solid #f59e0b;
      }

      .original-info h4 {
        color: #92400e;
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      .original-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }

      .original-stat {
        color: #78350f;
        font-size: 0.95em;
      }

      .original-stat strong {
        color: #92400e;
      }

      .analysis-panel {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border-left: 5px solid #3b82f6;
      }

      .analysis-panel h4 {
        color: #1e40af;
        margin-bottom: 15px;
        font-size: 1.1em;
      }

      .analysis-items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
      }

      .analysis-item {
        background: white;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .analysis-label {
        display: block;
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 5px;
      }

      .analysis-value {
        display: block;
        font-size: 1.2em;
        font-weight: 700;
        color: #1e40af;
        text-transform: capitalize;
      }

      .comparison-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 2000;
        padding: 20px;
        overflow: auto;
      }

      .comparison-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      .comparison-container {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 1400px;
        width: 100%;
        max-height: 90vh;
        overflow: auto;
      }

      .comparison-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .comparison-images {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .comparison-image-wrapper {
        position: relative;
        background: #000;
        border-radius: 15px;
        overflow: hidden;
      }

      .comparison-image {
        width: 100%;
        display: block;
      }

      .comparison-label {
        position: absolute;
        top: 15px;
        left: 15px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 15px;
        border-radius: 8px;
        font-weight: 600;
      }

      .spinner {
        border: 4px solid rgba(126, 34, 206, 0.2);
        border-top: 4px solid #7e22ce;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 15px 20px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 5px solid #dc2626;
        animation: shake 0.5s ease;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      @media (max-width: 1024px) {
        .comparison-view,
        .comparison-images {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2.5em;
        }
        .main-panel,
        .result-item {
          padding: 20px;
        }
        .controls,
        .metadata-grid,
        .analysis-items {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>üöÄ UltraCompress Pro</h1>
        <div class="subtitle">
          N√©n ·∫£nh th√¥ng minh v·ªõi AI - Dual Version Output
        </div>
        <div class="version">v2.0.1 Fixed</div>
      </header>

      <div class="main-panel">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">üì∏</div>
          <div class="upload-text">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</div>
          <div class="upload-hint">
            H·ªó tr·ª£: JPG, PNG, WebP, GIF, BMP, TIFF - Kh√¥ng gi·ªõi h·∫°n s·ªë l∆∞·ª£ng
          </div>
        </div>
        <input type="file" id="fileInput" accept="image/*" multiple />

        <div class="controls">
          <div class="control-group">
            <label for="qualityButtons">üéØ Ch·∫ø ƒë·ªô ch·∫•t l∆∞·ª£ng</label>
            <div class="quality-buttons" id="qualityButtons">
              <button class="quality-btn" data-quality="maximum">T·ªëi ƒëa</button>
              <button class="quality-btn active" data-quality="balanced">
                C√¢n b·∫±ng
              </button>
              <button class="quality-btn" data-quality="aggressive">
                M·∫°nh m·∫Ω
              </button>
            </div>
          </div>

          <div class="control-group">
            <label for="largePreset">üìê Preset L·ªõn</label>
            <select id="largePreset">
              <option value="864">864px - 45KB (4:3)</option>
              <option value="1024">1024px - 80KB (4:3)</option>
              <option value="1200">1200px - 100KB (16:9)</option>
            </select>
          </div>

          <div class="control-group">
            <label for="smallPreset">üìê Preset Nh·ªè</label>
            <select id="smallPreset">
              <option value="420">420px - 16KB (4:3)</option>
              <option value="600">600px - 30KB (4:3)</option>
              <option value="800">800px - 50KB (16:9)</option>
            </select>
          </div>

          <div class="control-group">
            <label for="concurrent">‚ö° X·ª≠ l√Ω ƒë·ªìng th·ªùi</label>
            <select id="concurrent">
              <option value="3">3 ·∫£nh / l·∫ßn</option>
              <option value="5" selected>5 ·∫£nh / l·∫ßn</option>
              <option value="10">10 ·∫£nh / l·∫ßn</option>
            </select>
          </div>
        </div>
      </div>

      <section class="progress-section" id="progressSection">
        <div class="progress-header">
          <h3>‚è≥ ƒêang x·ª≠ l√Ω...</h3>
          <div class="progress-stats">
            <span id="progressText">0 / 0</span>
          </div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <div class="progress-details">
          <div class="progress-item">
            <label>T·ªïng s·ªë ·∫£nh</label>
            <div class="value" id="totalFiles">0</div>
          </div>
          <div class="progress-item">
            <label>ƒê√£ ho√†n th√†nh</label>
            <div class="value" id="completedFiles">0</div>
          </div>
          <div class="progress-item">
            <label>T·ªïng th·ªùi gian</label>
            <div class="value" id="totalTime">0ms</div>
          </div>
          <div class="progress-item">
            <label>T·ªëc ƒë·ªô trung b√¨nh</label>
            <div class="value" id="avgSpeed">0 KB/s</div>
          </div>
        </div>
      </section>

      <div id="results" class="results-grid"></div>
    </div>

    <!-- Crop Modal -->
    <div class="crop-modal" id="cropModal">
      <div class="crop-container">
        <div class="crop-header">
          <h2>‚úÇÔ∏è C·∫Øt & ƒêi·ªÅu ch·ªânh ·∫£nh</h2>
          <button class="close-btn" onclick="closeCropModal()">‚úï ƒê√≥ng</button>
        </div>

        <div class="crop-preview-area" id="cropPreviewArea">
          <img id="cropImage" class="crop-image" alt="Crop preview" />
          <div class="crop-frame" id="cropFrame"></div>
        </div>

        <div class="crop-controls">
          <div class="crop-control">
            <label for="aspectRatio">T·ª∑ l·ªá khung h√¨nh</label>
            <select id="aspectRatio">
              <option value="1.3333">4:3 (M·∫∑c ƒë·ªãnh)</option>
              <option value="1.7777">16:9</option>
              <option value="1">1:1 (Vu√¥ng)</option>
              <option value="0.8">4:5 (D·ªçc)</option>
            </select>
          </div>
          <div class="crop-control">
            <label for="frameWidth">ƒê·ªô r·ªông khung (%)</label>
            <input
              type="number"
              id="frameWidth"
              value="80"
              min="20"
              max="100"
            />
          </div>
          <div class="crop-control">
            <label for="framePosX">V·ªã tr√≠ X (%)</label>
            <input type="number" id="framePosX" value="10" min="0" max="80" />
          </div>
          <div class="crop-control">
            <label for="framePosY">V·ªã tr√≠ Y (%)</label>
            <input type="number" id="framePosY" value="10" min="0" max="80" />
          </div>
        </div>

        <div class="crop-actions">
          <button class="btn btn-secondary" onclick="resetCrop()">
            Thi·∫øt l·∫≠p l·∫°i
          </button>
          <button class="btn btn-primary" onclick="applyCropAndCompress()">
            ‚úì √Åp d·ª•ng & N√©n
          </button>
        </div>
      </div>
    </div>

    <!-- Comparison Modal -->
    <div class="comparison-modal" id="comparisonModal">
      <div class="comparison-container">
        <div class="comparison-header">
          <h2>üîç So s√°nh c√°c phi√™n b·∫£n</h2>
          <button class="close-btn" onclick="closeComparisonModal()">
            ‚úï ƒê√≥ng
          </button>
        </div>
        <div class="comparison-images">
          <div class="comparison-image-wrapper">
            <img id="compareImage1" class="comparison-image" alt="Version 1" />
            <div class="comparison-label" id="compareLabel1">Phi√™n b·∫£n l·ªõn</div>
          </div>
          <div class="comparison-image-wrapper">
            <img id="compareImage2" class="comparison-image" alt="Version 2" />
            <div class="comparison-label" id="compareLabel2">Phi√™n b·∫£n nh·ªè</div>
          </div>
        </div>
        <div id="compareMetadata"></div>
      </div>
    </div>

    <!-- Link to the external library -->
    <script src="compresslib.js"></script>

    <!-- UI Logic Script -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ‚úÖ KI·ªÇM TRA TH∆Ø VI·ªÜN ƒê√É LOAD
        if (typeof UltraCompressPro === "undefined") {
          console.error("‚ùå UltraCompressPro library not found!");
          alert(
            "L·ªói: Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán n√©n ·∫£nh. Vui l√≤ng ki·ªÉm tra l·∫°i file compresslib.js"
          );
          return;
        }

        const compressor = new UltraCompressPro();

        // ‚úÖ VALIDATE LIBRARY
        const validation = compressor.validateLibrary();
        console.log("‚úÖ Library validation:", validation);

        let currentQuality = "balanced";
        let currentFiles = [];
        let currentCropFile = null;
        let cropSettings = {
          aspectRatio: 4 / 3,
          frameWidth: 80,
          posX: 10,
          posY: 10,
        };

        // Elements
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");
        const progressSection = document.getElementById("progressSection");
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");
        const resultsContainer = document.getElementById("results");

        // Quality selection
        document.querySelectorAll(".quality-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".quality-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            currentQuality = btn.dataset.quality;
          });
        });

        // Upload handlers
        uploadArea.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) =>
          handleFiles(Array.from(e.target.files))
        );

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          uploadArea.addEventListener(
            eventName,
            (e) => {
              e.preventDefault();
              e.stopPropagation();
            },
            false
          );
        });

        ["dragenter", "dragover"].forEach((eventName) => {
          uploadArea.addEventListener(
            eventName,
            () => uploadArea.classList.add("dragover"),
            false
          );
        });

        ["dragleave", "drop"].forEach((eventName) => {
          uploadArea.addEventListener(
            eventName,
            () => uploadArea.classList.remove("dragover"),
            false
          );
        });

        uploadArea.addEventListener(
          "drop",
          (e) => handleFiles(Array.from(e.dataTransfer.files)),
          false
        );

        async function handleFiles(files) {
          if (files.length === 0) return;

          if (files.length === 1) {
            showCropModal(files[0]);
            return;
          }

          currentFiles = files;
          processFiles();
        }

        async function processFiles() {
          progressSection.classList.add("active");
          resultsContainer.innerHTML = "";

          const concurrent = parseInt(
            document.getElementById("concurrent").value
          );
          const largePreset = getLargePreset();
          const smallPreset = getSmallPreset();

          document.getElementById("totalFiles").textContent =
            currentFiles.length;
          document.getElementById("completedFiles").textContent = "0";

          const startTime = performance.now();

          try {
            const result = await compressor.compressMultiple(currentFiles, {
              concurrent: concurrent,
              quality: currentQuality,
              customPresets: [largePreset, smallPreset],
              onProgress: (progress) => {
                // ‚úÖ PROGRESS CALLBACK ƒêANG HO·∫†T ƒê·ªòNG
                const percent = parseFloat(progress.percentage).toFixed(0);
                progressBar.style.width = percent + "%";
                progressBar.textContent = percent + "%";
                progressText.textContent = `${progress.processed} / ${progress.total}`;
                document.getElementById("completedFiles").textContent =
                  progress.processed;

                console.log(
                  `üìä Progress: ${percent}% - File: ${progress.currentFile}`
                );
              },
            });

            const totalTime = performance.now() - startTime;
            document.getElementById("totalTime").textContent =
              totalTime.toFixed(0) + "ms";

            const totalOriginalSize =
              result.summary.totalOriginalSize ||
              currentFiles.reduce((sum, f) => sum + f.size, 0);
            if (totalTime > 0) {
              const avgSpeed = totalOriginalSize / 1024 / (totalTime / 1000);
              document.getElementById("avgSpeed").textContent =
                avgSpeed.toFixed(2) + " KB/s";
            }

            result.results.forEach((item) => {
              if (item.success) {
                displayResult(item);
              } else {
                displayError(item);
              }
            });
          } catch (error) {
            console.error("‚ùå Process failed:", error);
            displayError({ fileName: "Unknown", error: error.message });
          }
        }

        function displayResult(item) {
          const div = document.createElement("div");
          div.className = "result-item";

          const { data } = item;
          const v1 = data.versions[0];
          const v2 = data.versions[1];

          div.innerHTML = `
                    <div class="result-header">
                        <h3>
                            <span>‚úÖ</span>
                            ${item.fileName}
                        </h3>
                        <span class="result-badge">2 Phi√™n b·∫£n</span>
                    </div>
                    <div class="original-info">
                        <h4>üìÅ ·∫¢nh g·ªëc</h4>
                        <div class="original-stats">
                            <div class="original-stat"><strong>K√≠ch th∆∞·ªõc:</strong> ${
                              data.original.sizeKB
                            } KB</div>
                            <div class="original-stat"><strong>ƒê·ªô ph√¢n gi·∫£i:</strong> ${
                              data.original.dimensions
                            }</div>
                            <div class="original-stat"><strong>ƒê·ªãnh d·∫°ng:</strong> ${
                              data.original.type
                            }</div>
                            ${
                              data.original.animated
                                ? `<div class="original-stat"><strong>S·ªë khung h√¨nh:</strong> ${data.original.frames}</div>`
                                : ""
                            }
                        </div>
                    </div>
                    <div class="analysis-panel">
                        <h4>üß† Ph√¢n t√≠ch AI</h4>
                        <div class="analysis-items">
                            <div class="analysis-item">
                                <span class="analysis-label">Kh·∫£ nƒÉng n√©n</span>
                                <span class="analysis-value">${
                                  data.analysis.compressibility
                                }/100</span>
                            </div>
                            <div class="analysis-item">
                                <span class="analysis-label">Lo·∫°i ·∫£nh</span>
                                <span class="analysis-value">${
                                  data.analysis.imageType
                                }</span>
                            </div>
                            <div class="analysis-item">
                                <span class="analysis-label">ƒê·ªô ph·ª©c t·∫°p</span>
                                <span class="analysis-value">${
                                  data.analysis.complexity
                                }</span>
                            </div>
                            <div class="analysis-item">
                                <span class="analysis-label">Trong su·ªët (Alpha)</span>
                                <span class="analysis-value">${
                                  data.analysis.hasTransparency ? "C√≥" : "Kh√¥ng"
                                }</span>
                            </div>
                        </div>
                    </div>
                    <div class="comparison-view">
                        ${createVersionCardHTML(v1, item, "L·ªõn")}
                        ${createVersionCardHTML(v2, item, "Nh·ªè")}
                    </div>
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="action-btn compare-btn" onclick="showComparison('${
                          v1.preview
                        }', '${v2.preview}', '${escapeHTML(
            JSON.stringify(v1.metadata)
          )}', '${escapeHTML(JSON.stringify(v2.metadata))}')">
                            üîç So s√°nh phi√™n b·∫£n
                        </button>
                    </div>
                `;
          resultsContainer.appendChild(div);
        }

        function createVersionCardHTML(version, item, title) {
          const { metadata, preview } = version;
          return `
                    <div class="version-card">
                        <div class="version-header">
                            <span class="version-title">üì± Phi√™n b·∫£n ${title}</span>
                            <span class="version-size">${
                              metadata.compressedSizeKB
                            } KB</span>
                        </div>
                        <div class="image-preview-wrapper">
                            <img src="${preview}" class="image-preview" alt="Version ${title}">
                            <div class="image-overlay">${
                              metadata.dimensions
                            }</div>
                        </div>
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <span class="metadata-label">G·ªëc</span>
                                <span class="metadata-value">${
                                  metadata.originalSizeKB
                                } KB</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">ƒê√£ n√©n</span>
                                <span class="metadata-value">${
                                  metadata.compressedSizeKB
                                } KB</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Ti·∫øt ki·ªám</span>
                                <span class="metadata-value highlight">${
                                  metadata.compressionRatio
                                }</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Th·ªùi gian</span>
                                <span class="metadata-value">${
                                  metadata.compressionTime
                                }</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Ch·∫•t l∆∞·ª£ng</span>
                                <span class="metadata-value">${
                                  metadata.quality
                                }</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">ƒê·ªãnh d·∫°ng</span>
                                <span class="metadata-value">${metadata.outputFormat
                                  .split("/")[1]
                                  .toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn download-btn" onclick="downloadImage('${preview}', '${title.toLowerCase()}_${
            item.fileName
          }')">
                                ‚¨áÔ∏è T·∫£i xu·ªëng
                            </button>
                        </div>
                    </div>
                `;
        }

        function displayError(item) {
          const div = document.createElement("div");
          div.className = "error-message";
          div.innerHTML = `<strong>‚ùå L·ªói v·ªõi file ${item.fileName}:</strong><br>${item.error}`;
          resultsContainer.appendChild(div);
        }

        function getPreset(type) {
          const selectId = type === "large" ? "largePreset" : "smallPreset";
          const value = document.getElementById(selectId).value;
          const presets = {
            864: {
              maxDimension: 864,
              targetSize: 45 * 1024,
              aspectRatio: 4 / 3,
            },
            1024: {
              maxDimension: 1024,
              targetSize: 80 * 1024,
              aspectRatio: 4 / 3,
            },
            1200: {
              maxDimension: 1200,
              targetSize: 100 * 1024,
              aspectRatio: 16 / 9,
            },
            420: {
              maxDimension: 420,
              targetSize: 16 * 1024,
              aspectRatio: 4 / 3,
            },
            600: {
              maxDimension: 600,
              targetSize: 30 * 1024,
              aspectRatio: 4 / 3,
            },
            800: {
              maxDimension: 800,
              targetSize: 50 * 1024,
              aspectRatio: 16 / 9,
            },
          };
          return presets[value];
        }

        const getLargePreset = () => getPreset("large");
        const getSmallPreset = () => getPreset("small");

        window.downloadImage = (url, filename) => {
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };

        function escapeHTML(str) {
          return str.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
        }

        // ===== CROP MODAL FUNCTIONS (FIXED) =====

        function showCropModal(file) {
          currentCropFile = file;
          const modal = document.getElementById("cropModal");
          const img = document.getElementById("cropImage");

          const reader = new FileReader();
          reader.onload = (e) => {
            img.src = e.target.result;
            img.onload = () => {
              resetCrop();
              modal.classList.add("active");
              setTimeout(initCropFrame, 50);
            };
          };
          reader.readAsDataURL(file);
        }

        window.closeCropModal = () => {
          document.getElementById("cropModal").classList.remove("active");
          const imgSrc = document.getElementById("cropImage").src;
          if (imgSrc.startsWith("blob:")) {
            URL.revokeObjectURL(imgSrc);
          }
          currentCropFile = null;
        };

        function initCropFrame() {
          const img = document.getElementById("cropImage");
          const frame = document.getElementById("cropFrame");

          if (img.offsetWidth === 0) {
            setTimeout(initCropFrame, 50);
            return;
          }

          let frameWidth = img.offsetWidth * (cropSettings.frameWidth / 100);
          let frameHeight = frameWidth / cropSettings.aspectRatio;

          if (frameHeight > img.offsetHeight) {
            frameHeight = img.offsetHeight;
            frameWidth = frameHeight * cropSettings.aspectRatio;
          }

          const availableWidth = img.offsetWidth - frameWidth;
          const availableHeight = img.offsetHeight - frameHeight;

          frame.style.width = `${frameWidth}px`;
          frame.style.height = `${frameHeight}px`;
          frame.style.left = `${
            img.offsetLeft + availableWidth * (cropSettings.posX / 100)
          }px`;
          frame.style.top = `${
            img.offsetTop + availableHeight * (cropSettings.posY / 100)
          }px`;

          makeDraggable(frame, img);
        }

        function makeDraggable(frame, img) {
          let isDragging = false,
            startX,
            startY,
            initialLeft,
            initialTop;

          const onStart = (e) => {
            isDragging = true;
            const event = e.touches ? e.touches[0] : e;
            startX = event.clientX;
            startY = event.clientY;
            initialLeft = frame.offsetLeft;
            initialTop = frame.offsetTop;
            e.preventDefault();
          };

          const onMove = (e) => {
            if (!isDragging) return;
            const event = e.touches ? e.touches[0] : e;
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;

            const minLeft = img.offsetLeft;
            const minTop = img.offsetTop;
            const maxLeft =
              img.offsetLeft + img.offsetWidth - frame.offsetWidth;
            const maxTop =
              img.offsetTop + img.offsetHeight - frame.offsetHeight;

            let newLeft = initialLeft + dx;
            let newTop = initialTop + dy;

            frame.style.left = `${Math.max(
              minLeft,
              Math.min(maxLeft, newLeft)
            )}px`;
            frame.style.top = `${Math.max(minTop, Math.min(maxTop, newTop))}px`;
          };

          const onEnd = () => {
            isDragging = false;
          };

          frame.onmousedown = onStart;
          document.onmousemove = onMove;
          document.onmouseup = onEnd;
          frame.ontouchstart = onStart;
          document.ontouchmove = onMove;
          document.ontouchend = onEnd;
        }

        document
          .getElementById("aspectRatio")
          .addEventListener("change", (e) => {
            cropSettings.aspectRatio = parseFloat(e.target.value);
            initCropFrame();
          });

        ["frameWidth", "framePosX", "framePosY"].forEach((id) => {
          document.getElementById(id).addEventListener("input", (e) => {
            const key = id.replace("frame", "").toLowerCase();
            cropSettings[key] = parseInt(e.target.value);
            initCropFrame();
          });
        });

        window.resetCrop = () => {
          cropSettings = {
            aspectRatio: 4 / 3,
            frameWidth: 80,
            posX: 10,
            posY: 10,
          };
          document.getElementById("aspectRatio").value = "1.3333";
          document.getElementById("frameWidth").value = "80";
          document.getElementById("framePosX").value = "10";
          document.getElementById("framePosY").value = "10";
          initCropFrame();
        };

        // ‚úÖ FIXED: S·ª≠ d·ª•ng public method loadImage()
        window.applyCropAndCompress = async () => {
          if (!currentCropFile) return;

          closeCropModal();
          progressSection.classList.add("active");
          resultsContainer.innerHTML = '<div class="spinner"></div>';

          try {
            const img = document.getElementById("cropImage");
            const frame = document.getElementById("cropFrame");

            // Calculate scale
            const originalImage = await compressor.loadImage(currentCropFile); // ‚úÖ PUBLIC METHOD
            const scaleX = originalImage.naturalWidth / img.offsetWidth;
            const scaleY = originalImage.naturalHeight / img.offsetHeight;

            // Calculate crop coordinates
            const cropX = (frame.offsetLeft - img.offsetLeft) * scaleX;
            const cropY = (frame.offsetTop - img.offsetTop) * scaleY;
            const cropWidth = frame.offsetWidth * scaleX;
            const cropHeight = frame.offsetHeight * scaleY;

            if (cropWidth <= 0 || cropHeight <= 0) {
              throw new Error("Invalid crop dimensions");
            }

            // Create cropped canvas
            const canvas = document.createElement("canvas");
            canvas.width = cropWidth;
            canvas.height = cropHeight;
            const ctx = canvas.getContext("2d");

            ctx.drawImage(
              originalImage,
              cropX,
              cropY,
              cropWidth,
              cropHeight,
              0,
              0,
              cropWidth,
              cropHeight
            );

            // Convert to blob
            const croppedBlob = await compressor.canvasToBlob(
              canvas,
              currentCropFile.type,
              0.98
            ); // ‚úÖ PUBLIC METHOD
            const croppedFile = new File(
              [croppedBlob],
              `cropped_${currentCropFile.name}`,
              { type: currentCropFile.type }
            );

            currentFiles = [croppedFile];
            processFiles();
          } catch (error) {
            console.error("‚ùå Crop failed:", error);
            displayError({
              fileName: currentCropFile.name,
              error: error.message,
            });
            progressSection.classList.remove("active");
          }
        };

        // ===== COMPARISON MODAL FUNCTIONS =====

        window.showComparison = (img1, img2, meta1Str, meta2Str) => {
          const modal = document.getElementById("comparisonModal");
          document.getElementById("compareImage1").src = img1;
          document.getElementById("compareImage2").src = img2;

          const meta1 = JSON.parse(
            meta1Str.replace(/&apos;/g, "'").replace(/&quot;/g, '"')
          );
          const meta2 = JSON.parse(
            meta2Str.replace(/&apos;/g, "'").replace(/&quot;/g, '"')
          );

          const metadataDiv = document.getElementById("compareMetadata");
          const sizeDiff = (
            parseFloat(meta1.compressedSizeKB) -
            parseFloat(meta2.compressedSizeKB)
          ).toFixed(2);
          const resolutionRatio =
            meta2.width > 0 ? (meta1.width / meta2.width).toFixed(2) : "N/A";
          const avgCompression = (
            (parseFloat(meta1.compressionRatio) +
              parseFloat(meta2.compressionRatio)) /
            2
          ).toFixed(2);

          metadataDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        ${createCompareStatsHTML("L·ªõn", meta1)}
                        ${createCompareStatsHTML("Nh·ªè", meta2)}
                    </div>
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 15px; margin-top: 20px; border-left: 5px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin-bottom: 10px;">üìä T√≥m t·∫Øt so s√°nh</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div>
                                <div style="font-size: 0.85em; color: #6b7280;">Ch√™nh l·ªách k√≠ch th∆∞·ªõc</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #1e40af;">${sizeDiff} KB</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; color: #6b7280;">T·ª∑ l·ªá ph√¢n gi·∫£i</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #1e40af;">${resolutionRatio}x</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; color: #6b7280;">N√©n trung b√¨nh</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #10b981;">${avgCompression}%</div>
                            </div>
                        </div>
                    </div>
                `;
          modal.classList.add("active");
        };

        function createCompareStatsHTML(title, meta) {
          return `
                    <div style="background: #f9fafb; padding: 20px; border-radius: 15px;">
                        <h3 style="color: #7e22ce; margin-bottom: 15px;">üì± Th·ªëng k√™ phi√™n b·∫£n ${title}</h3>
                        <div style="display: grid; gap: 10px;">
                            ${createCompareStatItem(
                              "K√≠ch th∆∞·ªõc:",
                              `${meta.compressedSizeKB} KB`
                            )}
                            ${createCompareStatItem(
                              "Ph√¢n gi·∫£i:",
                              meta.dimensions
                            )}
                            ${createCompareStatItem(
                              "Ti·∫øt ki·ªám:",
                              `${meta.compressionRatio}`,
                              "#10b981"
                            )}
                            ${createCompareStatItem(
                              "Ch·∫•t l∆∞·ª£ng:",
                              meta.quality
                            )}
                            ${createCompareStatItem(
                              "T·ªëc ƒë·ªô:",
                              meta.compressionSpeed
                            )}
                        </div>
                    </div>`;
        }

        function createCompareStatItem(label, value, valueColor = "inherit") {
          return `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px;">
                        <span style="color: #6b7280;">${label}</span>
                        <strong style="color: ${valueColor};">${value}</strong>
                    </div>`;
        }

        window.closeComparisonModal = () => {
          document.getElementById("comparisonModal").classList.remove("active");
        };

        // Image preview zoom
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("image-preview")) {
            const modal = document.createElement("div");
            modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                        background: rgba(0,0,0,0.95); z-index: 3000;
                        display: flex; align-items: center; justify-content: center;
                        padding: 20px; cursor: zoom-out; animation: fadeIn 0.3s ease;
                    `;
            const img = document.createElement("img");
            img.src = e.target.src;
            img.style.cssText =
              "max-width: 90%; max-height: 90%; border-radius: 15px;";

            modal.appendChild(img);
            document.body.appendChild(modal);

            modal.addEventListener("click", () => {
              document.body.removeChild(modal);
            });
          }
        });

        console.log(
          "%cüöÄ UltraCompress Pro v2.0.1 Ready!",
          "color: #7e22ce; font-size: 20px; font-weight: bold;"
        );
        console.log(
          "%c‚úÖ All features operational",
          "color: #10b981; font-size: 14px;"
        );
      });
    </script>
  </body>
</html>
